<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>派車簽單生成</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: "Microsoft JhengHei", "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont;
      background:#f5f5f5;
      margin:0;
      padding:16px;
    }
    .container {
      max-width:900px;
      margin:0 auto;
      background:#fff;
      padding:16px 16px 32px;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    h1{
      text-align:center;
      margin-top:0;
      font-size:24px;
    }
    form{
      display:flex;
      flex-direction:column;
      gap:12px;
      font-size:16px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    label{
      font-weight:bold;
    }
    input[type="text"],
    input[type="tel"],
    input[type="date"],
    input[type="time"],
    input[type="number"]{
      font-size:18px;
      padding:6px 8px;
      border:1px solid #ccc;
      border-radius:4px;
      width:100%;
      box-sizing:border-box;
    }
    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .row > .field{
      flex:1 1 150px;
    }
    .options{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      font-size:18px;
    }
    .options label{
      font-weight:normal;
    }
    button{
      margin-top:8px;
      padding:10px 16px;
      font-size:18px;
      border:none;
      border-radius:6px;
      background:#007bff;
      color:#fff;
      cursor:pointer;
    }
    button:active{
      transform:scale(0.98);
    }

    /* modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
    }
    .modal{
      background:#fff;
      max-width:95vw;
      max-height:95vh;
      padding:8px 8px 16px;
      border-radius:8px;
      box-sizing:border-box;
      text-align:center;
    }
    .modal img{
      max-width:100%;
      height:auto;
    }
    .modal button{
      margin-top:8px;
      background:#444;
    }
    .hint{
      font-size:13px;
      color:#555;
      margin-top:4px;
      text-align:center;
      line-height:1.4;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>派車、簽認單生成</h1>

  <form id="dispatchForm">
    <!-- 0. 公司抬頭 -->
    <div class="field">
      <label for="companyTitle">公司抬頭（上方：ＯＯ租賃有限公司）</label>
      <input id="companyTitle" type="text" value="ＯＯ租賃有限公司" />
    </div>

    <!-- 1. 客戶公司 -->
    <div class="field">
      <label for="clientCompany">客戶公司</label>
      <input id="clientCompany" type="text" placeholder="例如：○○旅行社" />
    </div>

    <!-- 2. 日期 -->
    <div class="field">
      <label for="date">日期</label>
      <input id="date" type="date" />
      <div class="hint">會自動轉成「X月X日」印在右上角</div>
    </div>

    <!-- 3. 送機／接機／包車 -->
    <div class="field">
      <label>用途</label>
      <div class="options">
        <label><input type="radio" name="serviceType" value="song" checked> 送機</label>
        <label><input type="radio" name="serviceType" value="jie"> 接機</label>
        <label><input type="radio" name="serviceType" value="bao"> 包車</label>
      </div>
    </div>

    <!-- 4. 開始/班機時間 -->
    <div class="field">
      <label for="startTime">開始／班機時間（24H）</label>
      <input id="startTime" type="time" />
    </div>

    <!-- 5–8 乘客／電話／起點／終點 -->
    <div class="row">
      <div class="field">
        <label for="passenger">乘客姓名</label>
        <input id="passenger" type="text" />
      </div>
      <div class="field">
        <label for="phone">乘客電話</label>
        <input id="phone" type="tel" />
      </div>
    </div>

    <div class="field">
      <label for="origin">起點</label>
      <input id="origin" type="text" placeholder="例如：○○飯店" />
    </div>

    <div class="field">
      <label for="destination">終點</label>
      <input id="destination" type="text" placeholder="例如：桃園機場第二航廈" />
    </div>

    <!-- 9. 是否舉牌 -->
    <div class="field">
      <label>是否舉牌接機</label>
      <div class="options">
        <label><input id="holdSign" type="checkbox"> 需要舉牌</label>
      </div>
    </div>

    <!-- 10. 車型 -->
    <div class="field">
      <label>車型</label>
      <div class="options">
        <label><input type="radio" name="carType" value="sedan" checked> 轎車</label>
        <label><input type="radio" name="carType" value="suv"> 休旅車</label>
        <label><input type="radio" name="carType" value="other"> 其他（九人座）</label>
      </div>
    </div>

    <!-- 11. 人數 -->
    <div class="field">
      <label for="people">人數</label>
      <input id="people" type="number" min="1" inputmode="numeric" />
    </div>

    <!-- 12–13 駕駛／車號 -->
    <div class="row">
      <div class="field">
        <label for="driver">駕駛</label>
        <input id="driver" type="text" />
      </div>
      <div class="field">
        <label for="carNo">車號</label>
        <input id="carNo" type="text" />
      </div>
    </div>

    <button type="submit">生成簽單圖片</button>
    <div class="hint">
      送出後會跳出預覽圖，手機可長按簽單圖片進行儲存或分享。
    </div>
  </form>
</div>

<!-- 模板底圖（不顯示，只給 Canvas 用） -->
<img id="templateImage" src="dispatch-template.jpg" alt="派車簽認單底圖" style="display:none;" />

<!-- 懸浮視窗 -->
<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div style="font-weight:bold;margin-bottom:4px;">已生成簽單</div>
    <img id="resultImage" alt="簽單預覽" />
    <div class="hint">
      手機：長按圖片即可儲存或轉傳。<br>
      電腦：可按下方按鈕下載。
    </div>
    <a id="downloadLink" download="dispatch-slip.png">
      <button type="button">下載 PNG 檔</button>
    </a>
    <button type="button" onclick="closeModal()">關閉視窗</button>
  </div>
</div>

<script>
  // ======== 需要套印的位置（之後覺得跑掉，只要改這裡的數字） ========
  const positions = {
    companyTitle: { x: 150,  y: 80 },   // ＯＯ租賃有限公司
    clientCompany:{ x: 200,  y: 200 },  // 客戶公司
    dateMonth:    { x: 1180, y: 80 },   // 日期： 月
    dateDay:      { x: 1400, y: 80 },   // 日期：   日
    passenger:    { x: 200,  y: 300 },  // 乘客
    phone:        { x: 600,  y: 300 },  // 電話
    origin:       { x: 200,  y: 410 },  // 起點
    destination:  { x: 200,  y: 500 },  // 終點
    startTime:    { x: 1150, y: 300 },  // (開始/班機)時間（整個 HH:MM）
    serviceSong:  { x: 1080, y: 200 },  // 送機勾選
    serviceJie:   { x: 1240, y: 200 },  // 接機勾選
    serviceBao:   { x: 1400, y: 200 },  // 包車勾選
    holdSign:     { x: 840,  y: 560 },  // 「舉牌接機」勾選
    carTypeSedan: { x: 200,  y: 650 },  // 轎車勾選
    carTypeSUV:   { x: 360,  y: 650 },  // 休旅車勾選
    carTypeOther: { x: 200,  y: 705 },  // 其他勾選
    people:       { x: 600,  y: 650 },  // 人數
    driver:       { x: 200,  y: 840 },  // 駕駛
    carNo:        { x: 600,  y: 840 }   // 車號
  };

  const templateImg = document.getElementById("templateImage");
  const form        = document.getElementById("dispatchForm");
  const modalBack   = document.getElementById("modalBackdrop");
  const resultImage = document.getElementById("resultImage");
  const downloadLink= document.getElementById("downloadLink");

  function openModal() {
    modalBack.style.display = "flex";
  }
  function closeModal() {
    modalBack.style.display = "none";
  }
  window.closeModal = closeModal; // 給 HTML onclick 用

  function drawText(ctx, text, pos, size = 48, bold = true) {
    if (!text) return;
    ctx.font = (bold ? "bold " : "") + size + 'px "Microsoft JhengHei","Noto Sans TC",system-ui';
    ctx.fillStyle = "#000";
    ctx.textBaseline = "top";
    ctx.fillText(text, pos.x, pos.y);
  }

  function drawCheck(ctx, pos, size = 48) {
    ctx.font = "bold " + size + 'px "Microsoft JhengHei","Noto Sans TC",system-ui';
    ctx.fillStyle = "#000";
    ctx.textBaseline = "top";
    ctx.fillText("✓", pos.x, pos.y);
  }

  form.addEventListener("submit", function (e) {
    e.preventDefault();

    if (!templateImg.complete) {
      templateImg.onload = () => generateSlip();
    } else {
      generateSlip();
    }
  });

  function generateSlip() {
    const canvas = document.createElement("canvas");
    canvas.width  = 1654; // 底圖實際尺寸
    canvas.height = 1166;
    const ctx = canvas.getContext("2d");

    // 畫上底圖
    ctx.drawImage(templateImg, 0, 0, canvas.width, canvas.height);

    // 取得表單資料
    const companyTitle = document.getElementById("companyTitle").value.trim();
    const clientCompany= document.getElementById("clientCompany").value.trim();
    const dateValue    = document.getElementById("date").value;
    const passenger    = document.getElementById("passenger").value.trim();
    const phone        = document.getElementById("phone").value.trim();
    const origin       = document.getElementById("origin").value.trim();
    const destination  = document.getElementById("destination").value.trim();
    const startTime    = document.getElementById("startTime").value;
    const holdSign     = document.getElementById("holdSign").checked;
    const people       = document.getElementById("people").value.trim();
    const driver       = document.getElementById("driver").value.trim();
    const carNo        = document.getElementById("carNo").value.trim();

    const serviceType  = document.querySelector('input[name="serviceType"]:checked').value;
    const carType      = document.querySelector('input[name="carType"]:checked').value;

    // 日期處理：轉成 月 / 日
    let monthText = "", dayText = "";
    if (dateValue) {
      const d = new Date(dateValue);
      if (!isNaN(d)) {
        monthText = String(d.getMonth() + 1);
        dayText   = String(d.getDate());
      }
    }

    // 時間：直接畫成 HH:MM
    let timeText = "";
    if (startTime) {
      timeText = startTime; // 24H HH:MM
    }

    // ===== 實際套印文字（字體偏大） =====
    drawText(ctx, companyTitle, positions.companyTitle, 52);
    drawText(ctx, clientCompany, positions.clientCompany, 48);
    drawText(ctx, monthText, positions.dateMonth, 48);
    drawText(ctx, dayText,   positions.dateDay,   48);

    drawText(ctx, passenger,   positions.passenger, 46);
    drawText(ctx, phone,       positions.phone,     46);
    drawText(ctx, origin,      positions.origin,    46);
    drawText(ctx, destination, positions.destination,46);
    drawText(ctx, timeText,    positions.startTime, 42);

    if (serviceType === "song") drawCheck(ctx, positions.serviceSong, 40);
    if (serviceType === "jie")  drawCheck(ctx, positions.serviceJie,  40);
    if (serviceType === "bao")  drawCheck(ctx, positions.serviceBao,  40);

    if (holdSign) drawCheck(ctx, positions.holdSign, 40);

    if (carType === "sedan") drawCheck(ctx, positions.carTypeSedan, 40);
    if (carType === "suv")   drawCheck(ctx, positions.carTypeSUV,   40);
    if (carType === "other") drawCheck(ctx, positions.carTypeOther, 40);

    drawText(ctx, people ? people + "人" : "", positions.people, 46);
    drawText(ctx, driver, positions.driver, 46);
    drawText(ctx, carNo,  positions.carNo,  46);

    // 匯出 PNG
    const dataUrl = canvas.toDataURL("image/png");
    resultImage.src   = dataUrl;
    downloadLink.href = dataUrl;
    openModal();
  }

  // 點背景也可以關閉
  modalBack.addEventListener("click", function(e){
    if (e.target === modalBack) closeModal();
  });
</script>
</body>
</html>
