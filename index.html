<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>派車簽單生成</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: "Microsoft JhengHei", "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont;
      background:#f5f5f5;
      margin:0;
      padding:16px;
    }
    .container {
      max-width:900px;
      margin:0 auto;
      background:#fff;
      padding:16px 16px 32px;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    h1{
      text-align:center;
      margin-top:0;
      font-size:24px;
    }
    form{
      display:flex;
      flex-direction:column;
      gap:12px;
      font-size:16px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    label{
      font-weight:bold;
    }
    input[type="text"],
    input[type="tel"],
    input[type="date"],
    input[type="time"],
    input[type="number"]{
      font-size:18px;
      padding:6px 8px;
      border:1px solid #ccc;
      border-radius:4px;
      width:100%;
      box-sizing:border-box;
    }
    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .row > .field{
      flex:1 1 150px;
    }
    .options{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      font-size:18px;
    }
    .options label{
      font-weight:normal;
    }
    button{
      margin-top:8px;
      padding:10px 16px;
      font-size:18px;
      border:none;
      border-radius:6px;
      background:#007bff;
      color:#fff;
      cursor:pointer;
    }
    button:active{
      transform:scale(0.98);
    }
    .hint{
      font-size:13px;
      color:#555;
      margin-top:4px;
      text-align:center;
      line-height:1.4;
    }

    /* modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
    }
    .modal{
      background:#fff;
      max-width:95vw;
      max-height:95vh;
      padding:8px 8px 16px;
      border-radius:8px;
      box-sizing:border-box;
      text-align:center;
    }
    .modal img{
      max-width:100%;
      height:auto;
    }
    .modal button{
      margin-top:8px;
      background:#444;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>派車、簽認單生成</h1>

  <form id="dispatchForm">
    <!-- 0. 公司抬頭 -->
    <div class="field">
      <label for="companyTitle">公司抬頭（上方）</label>
      <input id="companyTitle" type="text" value="ＯＯ租賃有限公司" />
    </div>

    <!-- 1. 客戶公司 -->
    <div class="field">
      <label for="clientCompany">客戶公司（左上公司：）</label>
      <input id="clientCompany" type="text" placeholder="例如：○○旅行社" />
    </div>

    <!-- 2. 日期 -->
    <div class="field">
      <label for="date">日期</label>
      <input id="date" type="date" />
      <div class="hint">會自動轉成「X月」「X日」印在右上。</div>
    </div>

    <!-- 3. 送機／接機／包車 -->
    <div class="field">
      <label>用途</label>
      <div class="options">
        <label><input type="radio" name="serviceType" value="song" checked> 送機</label>
        <label><input type="radio" name="serviceType" value="jie"> 接機</label>
        <label><input type="radio" name="serviceType" value="bao"> 包車</label>
      </div>
    </div>

    <!-- 4. 開始/班機時間 -->
    <div class="field">
      <label for="startTime">開始／班機時間（24H）</label>
      <input id="startTime" type="time" />
      <div class="hint">會顯示成「HH時MM分」覆蓋底圖上的「時／分」。</div>
    </div>

    <!-- 5–8 乘客／電話／起點／終點 -->
    <div class="row">
      <div class="field">
        <label for="passenger">乘客姓名</label>
        <input id="passenger" type="text" />
      </div>
      <div class="field">
        <label for="phone">乘客電話</label>
        <input id="phone" type="tel" />
      </div>
    </div>

    <div class="field">
      <label for="origin">起點</label>
      <input id="origin" type="text" placeholder="例如：○○飯店" />
    </div>

    <div class="field">
      <label for="destination">終點</label>
      <input id="destination" type="text" placeholder="例如：桃園機場第二航廈" />
    </div>

    <!-- 9. 是否舉牌 -->
    <div class="field">
      <label>是否舉牌接機</label>
      <div class="options">
        <label><input id="holdSign" type="checkbox"> 需要舉牌</label>
      </div>
    </div>

    <!-- 10. 車型 -->
    <div class="field">
      <label>車型</label>
      <div class="options">
        <label><input type="radio" name="carType" value="sedan" checked> 轎車</label>
        <label><input type="radio" name="carType" value="suv"> 休旅車</label>
        <label><input type="radio" name="carType" value="other"> 其他（九人座）</label>
      </div>
    </div>

    <!-- 11. 人數 -->
    <div class="field">
      <label for="people">人數</label>
      <input id="people" type="number" min="1" inputmode="numeric" />
    </div>

    <!-- 12–13 駕駛／車號 -->
    <div class="row">
      <div class="field">
        <label for="driver">駕駛</label>
        <input id="driver" type="text" />
      </div>
      <div class="field">
        <label for="carNo">車號</label>
        <input id="carNo" type="text" />
      </div>
    </div>

    <button type="submit">生成簽單圖片</button>
    <div class="hint">
      送出後會跳出預覽圖，手機可長按簽單圖片儲存或分享。
    </div>
  </form>
</div>

<!-- 底圖（給 Canvas 用，不顯示） -->
<img id="templateImage" src="dispatch-template.jpg" alt="派車簽認單底圖" style="display:none;" />

<!-- 懸浮視窗 -->
<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div style="font-weight:bold;margin-bottom:4px;">已生成簽單</div>
    <img id="resultImage" alt="簽單預覽" />
    <div class="hint">
      手機：長按圖片即可儲存或轉傳。<br>
      電腦：可按下方按鈕下載。
    </div>
    <a id="downloadLink" download="dispatch-slip.png">
      <button type="button">下載 PNG 檔</button>
    </a>
    <button type="button" onclick="closeModal()">關閉視窗</button>
  </div>
</div>

<script>
  // === 你提供的框座標＋大小 ===
  const boxes = {
    companyTitle:  { x: 69,   y: 12,  w: 1201, h: 174 }, // 公司抬頭
    clientCompany:{ x: 242,  y: 208, w: 592,  h: 134 }, // 客戶公司
    dateMonth:    { x: 1652, y: 230, w: 130,  h: 84  }, // 日期_月
    dateDay:      { x: 1851, y: 230, w: 123,  h: 84  }, // 日期_日
    serviceSong:  { x: 1473, y: 366, w: 73,   h: 96  }, // ✓送機
    serviceJie:   { x: 1660, y: 364, w: 71,   h: 101 }, // ✓接機
    serviceBao:   { x: 1849, y: 364, w: 70,   h: 104 }, // ✓包車
    passenger:    { x: 235,  y: 364, w: 530,  h: 130 }, // 乘客
    phone:        { x: 952,  y: 365, w: 500,  h: 123 }, // 電話
    startTime:    { x: 1482, y: 571, w: 517,  h: 82  }, // 開始/班機時間
    origin:       { x: 438,  y: 516, w: 1021, h: 130 }, // 起點
    destination:  { x: 438,  y: 669, w: 1022, h: 123 }, // 終點
    holdSign:     { x: 1160, y: 855, w: 75,   h: 108 }, // ✓舉牌
    carTypeSedan: { x: 257,  y: 966, w: 77,   h: 95  }, // ✓轎車
    carTypeSUV:   { x: 471,  y: 965, w: 84,   h: 101 }, // ✓休旅車
    carTypeOther: { x: 260,  y: 1071,w: 77,   h: 96  }, // ✓其他
    people:       { x: 986,  y: 1012,w: 253,  h: 119 }, // 人數
    driver:       { x: 244,  y: 1203,w: 410,  h: 101 }, // 駕駛
    carNo:        { x: 856,  y: 1200,w: 482,  h: 104 }  // 車號
  };

  const templateImg = document.getElementById("templateImage");
  const form        = document.getElementById("dispatchForm");
  const modalBack   = document.getElementById("modalBackdrop");
  const resultImage = document.getElementById("resultImage");
  const downloadLink= document.getElementById("downloadLink");

  function openModal() {
    modalBack.style.display = "flex";
  }
  function closeModal() {
    modalBack.style.display = "none";
  }
  window.closeModal = closeModal;

  // 自動換行＋自適應字體（全部靠左）
  function drawAutoFitText(ctx, text, box, options = {}) {
    if (!text) return;
    const maxFont = options.maxFont || 48;   // 你指定：最大 48
    const minFont = options.minFont || 20;
    const lineHeightRatio = options.lineHeight || 1.15;

    let fontSize = maxFont;
    let lines = [];

    while (fontSize >= minFont) {
      ctx.font = `bold ${fontSize}px "Microsoft JhengHei","Noto Sans TC",system-ui`;
      lines = [];
      let current = "";

      for (const ch of text) {
        const test = current + ch;
        if (ctx.measureText(test).width > box.w && current !== "") {
          lines.push(current);
          current = ch;
        } else {
          current = test;
        }
      }
      if (current) lines.push(current);

      const lineHeight = fontSize * lineHeightRatio;
      const totalHeight = lines.length * lineHeight;

      if (totalHeight <= box.h) break; // 這個字級塞得下
      fontSize -= 2;
    }

    const lineHeight = fontSize * lineHeightRatio;
    ctx.font = `bold ${fontSize}px "Microsoft JhengHei","Noto Sans TC",system-ui`;
    ctx.fillStyle = "#000";
    ctx.textBaseline = "top";

    let y = box.y;
    for (const line of lines) {
      ctx.fillText(line, box.x, y); // 全部靠左
      y += lineHeight;
      if (y > box.y + box.h - lineHeight) break;
    }
  }

  // 勾選框：在框內置中畫 ✓
  function drawCheck(ctx, box) {
    const mark = "✓";
    const size = Math.min(box.w, box.h) * 0.9;
    ctx.font = `bold ${size}px "Microsoft JhengHei","Noto Sans TC",system-ui`;
    ctx.fillStyle = "#000";
    ctx.textBaseline = "top";
    const w = ctx.measureText(mark).width;
    const x = box.x + (box.w - w) / 2;
    const y = box.y + (box.h - size) / 2;
    ctx.fillText(mark, x, y);
  }

  form.addEventListener("submit", function (e) {
    e.preventDefault();

    if (!templateImg.complete) {
      templateImg.onload = generateSlip;
    } else {
      generateSlip();
    }
  });

  function generateSlip() {
    const canvas = document.createElement("canvas");
    // 用底圖的實際尺寸當作 Canvas 尺寸
    const w = templateImg.naturalWidth || 2000;
    const h = templateImg.naturalHeight || 1400;
    canvas.width  = w;
    canvas.height = h;
    const ctx = canvas.getContext("2d");

    // 畫上底圖
    ctx.drawImage(templateImg, 0, 0, canvas.width, canvas.height);

    // 表單資料
    const companyTitle = document.getElementById("companyTitle").value.trim();
    const clientCompany= document.getElementById("clientCompany").value.trim();
    const dateValue    = document.getElementById("date").value;
    const passenger    = document.getElementById("passenger").value.trim();
    const phone        = document.getElementById("phone").value.trim();
    const origin       = document.getElementById("origin").value.trim();
    const destination  = document.getElementById("destination").value.trim();
    const startTimeRaw = document.getElementById("startTime").value;
    const holdSign     = document.getElementById("holdSign").checked;
    const people       = document.getElementById("people").value.trim();
    const driver       = document.getElementById("driver").value.trim();
    const carNo        = document.getElementById("carNo").value.trim();
    const serviceType  = document.querySelector('input[name="serviceType"]:checked').value;
    const carType      = document.querySelector('input[name="carType"]:checked').value;

    // 日期：拆成月 / 日
    let monthText = "", dayText = "";
    if (dateValue) {
      const d = new Date(dateValue);
      if (!isNaN(d)) {
        monthText = String(d.getMonth() + 1);
        dayText   = String(d.getDate());
      }
    }

    // 時間：轉成「HH時MM分」
    let startTimeText = "";
    if (startTimeRaw) {
      const parts = startTimeRaw.split(":");
      if (parts.length === 2) {
        const hh = parts[0];
        const mm = parts[1];
        startTimeText = `${hh}時${mm}分`;
      } else {
        startTimeText = startTimeRaw;
      }
    }

    // ===== 套印文字（全部靠左，自適應字體） =====
    drawAutoFitText(ctx, companyTitle, boxes.companyTitle);
    drawAutoFitText(ctx, clientCompany, boxes.clientCompany);
    drawAutoFitText(ctx, monthText, boxes.dateMonth);
    drawAutoFitText(ctx, dayText,   boxes.dateDay);

    drawAutoFitText(ctx, passenger,   boxes.passenger);
    drawAutoFitText(ctx, phone,       boxes.phone);
    drawAutoFitText(ctx, startTimeText, boxes.startTime);
    drawAutoFitText(ctx, origin,      boxes.origin);
    drawAutoFitText(ctx, destination, boxes.destination);

    if (people) {
      drawAutoFitText(ctx, people + "人", boxes.people);
    }

    drawAutoFitText(ctx, driver, boxes.driver);
    drawAutoFitText(ctx, carNo,  boxes.carNo);

    // 勾選
    if (serviceType === "song") drawCheck(ctx, boxes.serviceSong);
    if (serviceType === "jie")  drawCheck(ctx, boxes.serviceJie);
    if (serviceType === "bao")  drawCheck(ctx, boxes.serviceBao);

    if (holdSign) drawCheck(ctx, boxes.holdSign);

    if (carType === "sedan") drawCheck(ctx, boxes.carTypeSedan);
    if (carType === "suv")   drawCheck(ctx, boxes.carTypeSUV);
    if (carType === "other") drawCheck(ctx, boxes.carTypeOther);

    // 匯出 PNG
    const dataUrl = canvas.toDataURL("image/png");
    resultImage.src   = dataUrl;
    downloadLink.href = dataUrl;
    openModal();
  }

  // 點背景也可關閉
  modalBack.addEventListener("click", function(e){
    if (e.target === modalBack) closeModal();
  });
</script>
</body>
</html>
